#!/bin/bash
data=(
0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00
0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00
0x00 0x82 0x21 0x00 0x00 0x00 0x00 0x02 0x39 0x0F 0x00 0x00 0x00 0x40 0x00 0x00
0x3F 0x06 0x5B 0x4F 0x66 0x6D 0x7D 0x07 0x7F 0x6F 0x00 0x00 0x00 0x48 0x00 0x53
0x00 0x77 0x7C 0x39 0x5E 0x79 0x71 0x6F 0x76 0x06 0x1E 0x00 0x38 0x00 0x54 0x3F
0x73 0x67 0x50 0x6D 0x78 0x3E 0x00 0x00 0x00 0x6E 0x00 0x39 0x00 0x0F 0x00 0x08
0x63 0x5F 0x7C 0x58 0x5E 0x7B 0x71 0x6F 0x74 0x02 0x1E 0x00 0x06 0x00 0x54 0x5C
0x73 0x67 0x50 0x6D 0x78 0x1C 0x00 0x00 0x00 0x6E 0x00 0x39 0x30 0x0F 0x00 0x00
)

raw_disp() {
  ascii=$(printf "%d" "'$2")
  value=${data[$ascii]}
  i2cset -y 1 $1 $value
}

disp() {
  if [ "$1" = "" ]; then
    raw_disp 0x34 ''
    return
  fi
  i2cset -y 1 0x24 0x1
  raw_disp 0x34 ${1:0:1}
  raw_disp 0x35 ${1:1:1}
  raw_disp 0x36 ${1:2:1}
  raw_disp 0x37 ${1:3:1}
  sleep 0.3
  disp "${1:1}"
}

if [ ! -e /tmp/screen ]; then
  cat <<EOF > /tmp/screen
   IP=\${IP}
   RES=\${CPU} ${RAM}
EOF
fi

while `true`; do
  IFS=$'\n'
  export IP=`hostname -I 2>&1 | sed "s# .*##g"`
  export RAM=`awk '/^Mem/ { printf("%.0f", 100*$3/$2) }' <(free -m)`
  export CPU=`top -bn1 | grep "Cpu(s)" | awk '{printf("%.0f",100-$8)}'`
  for i in `envsubst < /tmp/screen`; do
    disp "$i"
    sleep 1
  done
done